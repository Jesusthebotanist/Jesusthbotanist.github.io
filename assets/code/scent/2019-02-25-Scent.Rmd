---
output: html_document
header-includes: \usepackage{titling}
layout: post
categories: Projects
image: Scent.png
---
During my undergrad I had the fantastic oppertunity to help a fellow undergrad in the lab, Theresa Wang, with her thesis project. Her thesis was a collaberative project between Veronica Di Stilio and Jeff Riffel's lab to investigated the floral scent profiles between insect and wind pollinated species of *Thalictrum*. The paper was published last in [Annuals of Botany](https://academic.oup.com/aob/article/123/2/289/5056502) (Email me if you're stuck behind paywall). I joined the group while I was taking [BIOL 419: Data Science for Biologist](https://docs.wixstatic.com/ugd/b83b01_bb7ba7ff3216490eab0c86c628431108.pdf) my first every computing class; I need a project for the course and Theresa had some data just for that! The entire experiance really pushed me to learn skill that I am now utalizing in my Ph.D, as well as a nice change of pace from all the PCR I was running. 

I performed non-multidimensional scaling (nMDS) and test for phylogenetic signal. Unfortently the nMDS analysis is written in Matlab while the rest is in R, because coding using Matlab before I switched to the free R. The following is a slight modificaiton from the published supplementary material found in this [github repo](https://github.com/Jesusthebotanist/Thalictrum-Floral-Scent) for the R portion of the analysis. The data is floral scent analyzed by gas chromatography-mass spectrometry from 11 species of Thalictrum and electroantennogram (EAG) responses from  buff-tailed bumblebee antenna exposed to floral scent extract from each *Thalictrum* species. This script does two things,

1) Calculates Blomberg's K for the floral scent data to asses phylogenetic signal. 

2) Performed an ancestral state reconstrion of bumble bee EAG response

3) Generates Figure 4 from the manuscript

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '/Volumes/GoogleDrive/My Drive/Projects/Jesusthebotanist.github.io')
knitr::opts_chunk$set(echo=TRUE, warning = FALSE, message = FALSE)
```

###Load Libraries and Data
``` {r Library and Import data }
#Load Libraries
library(phytools)
library(geiger)
library(picante) 
library(phylocurve)
library(geomorph)
library(diversitree)

# Import Scent GCMS floral scent data
scent <- read.csv("assets/code/scent/compounds.csv") 

# Read in pre-cooked Maximum A Posterior Phylogeny (MAP)
tree <-read.nexus("assets/code/scent/THALICTRUM86.tre") 

# Import EAG data
EAG <- read.csv("assets/code/scent/EAGresponses.csv")
```

## Test for Phylogenetic Signal

Prune MAP phylogeny to species with GCMS data
```{r Trim Tree for Phylogenetic Signal}
keepSpecies <- unique(as.character(scent$Species_Name_Full))

trimedTree <- drop.tip(tree,tree$tip.label[-match(keepSpecies, tree$tip.label)])

plot(trimedTree) 
```


Extract scent emission data take the averge of biological replicates and wrangle the data into the proper formate for the downstream functons. 
```{r Scent Data Wrangle, results="hide"}
#1) 
scentCompounds <- scent[,9:63] # extract only scent data including mass*time column
scentCompounds$Species_Name_Full <- scent$Species_Name_Full 

#2)  Average Scent Data across 
avgScentCompounds <- aggregate( scentCompounds, 
                                by=list(scentCompounds$Species_Name_Full),
                                FUN = mean,
                                na.rm=TRUE)
#3)       
avgScentCompounds$Species_Name_Full <- NULL
row.names(avgScentCompounds) <- avgScentCompounds$Group.1
avgScentCompounds$Group.1 <- NULL
avgScentCompounds <- as.matrix(avgScentCompounds)
head(avgScentCompounds)
```

The multiPhylosignal from picant test data runs 
```{r BlombergsK Individual, results="hide"}
# Picante
x <- multiPhylosignal(avgScentCompounds, tree)
```

## Multivariate Bloombergs K
Two implementations of multivarite Bloombergs K:

### Phylocurve Implimentation 
Significance is assessd by simulating a brownian motion on a star phylogeny. 

```{r Phylocurve Multivarite BloombergsK}
model <- evo.model(trimedTree, avgScentCompounds)  
K.mult(model, nsim = 1000, plot = TRUE)
```
Figure Interpretation:
Black density plot is null distribution of K values from 1000 simulations of Brownian motion under a star phylogeny. Blue is a distribution of K values from 1000 simulations on the true phylogeny. Black dotted line is observe K value from multiveriate Bloomberg's K on observed data. This value falls well within the null distribution of simulation, indicating that there is no phylogenetic signal. 

### Geomorph Implimentation 
Significance is assessed by permuting the data along the tips of the phylogeny. 

```{r Geomorph Multivarite BloombergsK}
zzz<-physignal(avgScentCompounds,trimedTree)
zzz
```

# Ancestral State Reconstruction Data Wrangle
## Prune Tree down to 8 species with EAG data
```{r Trim Tree for Ancestral State Reconstruction}
keepSpecies <- EAG$Species_Name_Full

trimedTree<-drop.tip(tree,tree$tip.label[-match(keepSpecies, tree$tip.label)])

plot(trimedTree) 
```

## Data Wrangle EAG Response 
```{r EAGResponse Data Wrangle}
continuousResponse <- as.matrix(data.frame(row.names = EAG$Species_Name_Full,
                                 EAG$EAG))[,1]

sigResponses <- as.matrix(data.frame(row.names = EAG$Species_Name_Full,
                                    EAG$EAG_Sig))[,1]
```

```{r EAG BloombergK}
EAGBloombergsK <- as.matrix(continuousResponse)

multiPhylosignal(EAGBloombergsK, tree)
```

# Ancestrl State Reconstruction
```{r EAGAncStateRecon }
g <- contMap(trimedTree, continuousResponse, plot = TRUE, type="phylogram")
````

```{r Significant }
# Testing between ER and ARD
results.anc <- data.frame( model=c("ER","ARD"),
                           lnL=numeric(2),
                           AICc=numeric(2),
                           params=numeric(2))

ER_fit <- fitDiscrete(trimedTree, sigResponses, model="ER")
results.anc[1,-1]<- c(lnL=ER_fit$opt$lnL,AICc=ER_fit$opt$aicc,ER_fit$opt$k)
ARD_fit <- fitDiscrete(trimedTree, sigResponses, model="ARD")
results.anc[2,-1]<- c(lnL=ARD_fit$opt$lnL,AICc=ARD_fit$opt$aicc,ARD_fit$opt$k)
results.anc <- results.anc[order(results.anc$AICc),]
results.anc

# Plotting Joint Marginal Estimation of ER
z <- as.factor(sigResponses)

ERreconstruction <- ace(z, trimedTree, type="discrete", model="ER")

plotTree(trimedTree, setEnv = TRUE, offset = 0.5)
tiplabels(pie = to.matrix(z, sort(unique(z))), 
          piecol = c("#F8766D", "#00BFC4"), 
          cex = 0.4)
nodelabels( node=1:trimedTree$Nnode+Ntip(trimedTree),
            pie = ERreconstruction$lik.anc,
            cex=0.6, 
            piecol = c("#F8766D", "#00BFC4"))

nodelabels(
            pie = ERreconstruction$lik.anc,
            piecol = c("#F8766D", "#00BFC4"),
            cex = 0.6)


legend("topleft",
       legend=c("Significant EAG", "Non-Significant EAG"),
       pch=20,
       col=c("#F8766D", "#00BFC4"),
       bty="n",
       text.col="gray32",
       cex=0.8,
       pt.cex=1.5)
```

```{r Stoachatstic Charactermaping}
set.seed(1234)
cols <- setNames(c("#1b9e77","#7570b3","#d95f02"), sort(unique(sigResponses)))
chartrees <- make.simmap(trimedTree, sigResponses, model='ER', nsim = 200)
(res_simmap <- describe.simmap(chartrees, plot = FALSE))

plot( trimedTree,type="p",
      FALSE,label.offset=0.6,
      cex=0.6,
      no.margin=TRUE,
       edge.color="gray32",
      tip.color="gray32")

tiplabels( pch=21,bg=cols[as.numeric(sigResponses)],
           col="gray32",
           cex=1,
           adj=0.6)
nodelabels( pie=res_simmap$ace,
            piecol=cols,
            cex=0.5,
            col="gray32")

#legend("bottomleft",
#       legend=levels(sigResponses),
#       pch=20,
#       col="gray32",
#       bty="n",
#       text.col="gray32",
#       cex=0.8,
#       pt.cex=1.5)


#plotSimmap(chartrees, cols, pts = FALSE, lwd = 3, fsize=0.6)
#add.simmap.legend(colors = cols, vertical = FALSE, prompt = FALSE, x = 0, y = 1)


```